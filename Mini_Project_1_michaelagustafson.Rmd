---
title: "Mini Project 1"
author: "Michaela Gustafson"
date: "10/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Spatial Data in R: Mini Project 1

The goals for this phase of your final project are:

Articulate an interesting research question based on a dataset you’d like to learn more about.

Develop a spatial database that contains potentially relevant explanatory variables that you’d like to explore in the context of that research question.

Demonstrate an understanding of the various workflow elements involved in designing and constructing a spatial database for subsequent visualization and analysis.


My Question:
Where is the best place to go in New Zealand during the zombie apocalypse to avoid infection and survive?
Specifically, I will look at 
1. Where the most zombie attacks are happening
2. Are they happening in more urban or rural locations?
3. Highlight rural locations as areas of survival (the less people around, the less chance of encountering an infected person and becoming a zomibe)
4. Number of pharmacies in each city>>region to inform survivors of the best places to go where they will have regular access to medical supplies

  

I will answer this question using the following data:

- Census information (population, population density)
- Urban and rural district classifications
- Land area (sqkm)
- Locations and number of zombie attacks


```{r library}
library(here)
library(tidyr)
library(dplyr)
library(terra)
library(sf)
library(tidyverse)
library(ggmap)
```

# A. Dependent Variable with Point Geometry: Zombie Attacks

Data source: kaggle.com


```{r zombieload}

zom <- read.csv("zombies.csv")

head(zom); dim(zom)

zombie.shp <- read_sf(here("New_Zealand_Zombie_Attack_Data.shp"))
plot(zombie.shp)

```

# B. Regions

## 1. New Zealand Region Data
 Data source: https://datafinder.stats.govt.nz/layer/98765-regional-council-2019-clipped-generalised/

The regions of New Zealand are my 'regions' I will use to organize higher order variables.

```{r gitnzcencsu}
# Find "Regional Council 2018 Clipped (generalised)"
# select the GeoPackage option in the "Vectors/tables" dropdown
# at https://datafinder.stats.govt.nz/data/ (requires registration)
# Save the result as:

unzip("statsnzregional-council-2019-clipped-generalised-SHP.zip")
nz.full.shp <- st_read("regional-council-2019-clipped-generalised.shp")

plot(st_geometry(nz.full.shp))
# print(object.size(nz_full), units = "Kb") # 14407.2 Kb

# nz <- st_simplify(nz_full, dTolerance = 1000)


names(nz.full.shp)
nz.full.shp$REGC2019_1
nz.reg.shp = filter(nz.full.shp, REGC2019_1 != "Area Outside Region") %>%
        select(Region = REGC2019_1, AreaSQKM = AREA_SQ_KM, geometry)

st_is_valid(nz.reg.shp)
st_crs(nz.reg.shp)

```
# C. Tabular Data
## 1. Census Data

Data source: https://www.stats.govt.nz/topics/census

I will use census data to determine the population density/sqkm in areas of the regions (urban vs rural) and overall population density/sqkm of a region. This information will be best used to determine good regions for individuals to go to be in less populated areas and have a better chance of avoiding other people and potential zombie infection.

```{r nzcensus}
# read in census data
nz.census <- read.csv("Census_Usually_resident_population_count_and_change_by_region_2006_2013_and_2018.csv")

# filter to get most recent census population (2018)
names(nz.census)
nz.census <- filter(nz.census, X...Census.year == "2018") %>%
  select(Year = X...Census.year, Region, Population = Value)

```



# D. Spatial Data
## 1. Urban vs Rural shapefile

Data source: https://datafinder.stats.govt.nz/layer/98743-urban-rural-2019-clipped-generalised/

```{r urbrur}
unzip("statsnzurban-rural-2019-clipped-generalised-SHP.zip")
urbrur <- read_sf("urban-rural-2019-clipped-generalised.shp")
plot(st_geometry(urbrur))

urban <- urbrur %>%
  select(Name = UR2019_V_1, Urban = IUR2019__1, AreaSQKM = AREA_SQ_KM, geometry)


```

# 2. Pharmacy Location Data
Data source: https://fyi.org.nz/request/10183-total-number-of-licenced-pharmacies-in-nz-2019

Does this still count as tabular data even though I turned it into spatial data??
```{r}

#?register_google
#register_google(key = "AIzaSyAqigVAND9UsFfCnlKTIoVxmkhJOjV3Po0", write = TRUE)

#nz.pharm <- read.csv("Pharmacy Database.csv")

#nz.pharm <- nz.pharm %>%
 # select(Pharmacy_Nm = PREMISES_NAME, Street = STREET_ADDRESS, Suburb = #STREET_ADDRESS_SUBURB_RD, City = STREET_ADDRESS_TOWN_CITY, zip = STREET_ADDRESS_POST_CODE)

#head(nz.pharm)

# create address column with full address (minus postal code)
#nz.pharm$address <- paste(nz.pharm$Street, nz.pharm$Suburb, nz.pharm$City, sep = ",")
# remove double "," for those that didn't have a suburb listed
#nz.pharm$address <- gsub(",,", ",", nz.pharm$address)

# initialize dataframe
#geocoded <- data.frame(stringsAsFactors = FALSE)

#for(i in 1:nrow(nz.pharm)) {
  # Print("Working...")
 # result <- geocode(nz.pharm$address[i], output = "latlona", source = "google")
 # nz.pharm$lon[i] <- as.numeric(result[1])
  #nz.pharm$lat[i] <- as.numeric(result[2])
#}

#write.csv(nz.pharm, here("nz.pharm.csv"))

# read in pharmacy csv created above that now has location data:

nz.pharm <- read.csv(here("nz.pharm.csv"))

nz.pharm <- na.omit(nz.pharm)
nz.pharm.sf <- st_as_sf(nz.pharm, coords = c("lon", "lat"), crs = 4326)
st_crs(nz.pharm.sf)
nz.pharm.proj <- st_transform(nz.pharm.sf, crs = st_crs(nz.reg.shp))
st_crs(nz.reg.shp) == st_crs(nz.pharm.proj)

plot(st_geometry(nz.reg.shp))
plot(st_geometry(nz.pharm.proj), add = TRUE)
#looks alright
```

# E. Creating Database

Spatial Join

# Join urban/rural information with regions using st_is_within

```{r}

st_crs(urban) == st_crs(nz.reg.shp)

region.urban.join <- st_join(urban, nz.reg.shp, join=st_within)

# yayayya ended up with same number of observations as in the 'urban' dataset. But we have some urban districts that didn't match up with a region. Not as many as with the datasets used prior, but still unsure how to fix this.

```

## Join Zombie Attack locations with regions, and urban/rural:

```{r}
# make sure all are in the same CRS
st_crs(zombie.shp) == st_crs(region.urban.join)

st_crs(zombie.shp)
st_crs(region.urban.join)

?st_transform
zombie.shp.proj <- st_transform(zombie.shp, crs = st_crs(region.urban.join))

st_crs(zombie.shp.proj) == st_crs(region.urban.join)


# or, first can join attacks with urban districts then further summarize that to regions

urban.zombie.join <- st_join(zombie.shp.proj, urban, join = st_within)
# combine zombie attacks with region data
region.zombie.join <- st_join(nz.reg.shp, zombie.shp.proj, join = st_contains)
```

C. Constructing Database

# Summarize

## Summarize the number of attacks per region

```{r}
attacks.per.region <- region.zombie.join %>% 
  group_by(Region) %>% 
  summarize(., Total_Attacks = sum(Attacks))

print(attacks.per.region)


# get population density for each region? And then attacks/pop/sqkm?
```

```{r pharmperregion}

# Find the number of pharmacies per region

pharm.per.region <- st_join(nz.reg.shp, nz.pharm.proj, join = st_contains)

head(pharm.per.region)
```

























