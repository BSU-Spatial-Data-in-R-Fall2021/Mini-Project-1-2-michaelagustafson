---
title: "Mini Project 1"
author: "Michaela Gustafson"
date: "10/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Spatial Data in R: Mini Project 1

The goals for this phase of your final project are:

Articulate an interesting research question based on a dataset you’d like to learn more about.

Develop a spatial database that contains potentially relevant explanatory variables that you’d like to explore in the context of that research question.

Demonstrate an understanding of the various workflow elements involved in designing and constructing a spatial database for subsequent visualization and analysis.


My Question:
Where is the best place to go in New Zealand during the zombie apocalypse to avoid infection and survive?
Specifically, I will look at 
1. Where the most zombie attacks are happening
2. Are they happening in more urban or rural locations?
3. Highlight rural locations as areas of survival (the less people around, the less chance of encountering an infected person and becoming a zomibe)
4. Number of pharmacies in each city>>region to inform survivors of the best places to go where they will have regular access to medical supplies

  

I will answer this question using the following data:

- Census information (population, population density)
- Urban and rural district classifications
- Land area (sqkm)
- Locations and number of zombie attacks


```{r library}
library(here)
library(tidyr)
library(dplyr)
library(terra)
library(sf)
library(tidyverse)
library(nngeo)
library(data.table)
# library(ggmap)
```

# A. Dependent Variable with Point Geometry: Zombie Attacks

Data source: kaggle.com


```{r zombieload}

zom <- read.csv("zombies.csv")

head(zom); dim(zom)

zombie.shp <- read_sf(here("New_Zealand_Zombie_Attack_Data.shp"))
plot(zombie.shp)

```

# B. Regions

## 1. New Zealand Region Data
 Data source: https://datafinder.stats.govt.nz/layer/98765-regional-council-2019-clipped-generalised/

The regions of New Zealand are my 'regions' I will use to organize higher order variables.

```{r nzregions}
# Find "Regional Council 2018 Clipped (generalised)"
# select the GeoPackage option in the "Vectors/tables" dropdown
# at https://datafinder.stats.govt.nz/data/ (requires registration)
# Save the result as:

unzip("statsnzregional-council-2019-clipped-generalised-SHP.zip")
nz.full.shp <- st_read("regional-council-2019-clipped-generalised.shp")

plot(st_geometry(nz.full.shp))
# print(object.size(nz_full), units = "Kb") # 14407.2 Kb

# nz <- st_simplify(nz_full, dTolerance = 1000)


names(nz.full.shp)
nz.full.shp$REGC2019_1
nz.reg.shp = filter(nz.full.shp, REGC2019_1 != "Area Outside Region") %>%
        select(Region = REGC2019_1, AreaSQKM = AREA_SQ_KM, geometry)

st_is_valid(nz.reg.shp)
st_crs(nz.reg.shp)

```
# C. 1. Census Data

Data source: https://www.stats.govt.nz/topics/census

I will use census data to determine the population density/sqkm in areas of the regions (urban vs rural) and overall population density/sqkm of a region. This information will be best used to determine good regions for individuals to go to be in less populated areas and have a better chance of avoiding other people and potential zombie infection.

```{r nzcensus}
# read in census data
nz.census <- read.csv("Census_Usually_resident_population_count_and_change_by_region_2006_2013_and_2018.csv")

# filter to get most recent census population (2018)
names(nz.census)
nz.census <- filter(nz.census, X...Census.year == "2018") %>%
  select(Year = X...Census.year, Region, Population = Value)

```



# 2. Urban vs Rural shapefile

Data source: https://datafinder.stats.govt.nz/layer/98743-urban-rural-2019-clipped-generalised/

```{r urbrur}
unzip("statsnzurban-rural-2019-clipped-generalised-SHP.zip")
urbrur <- read_sf("urban-rural-2019-clipped-generalised.shp")
plot(st_geometry(urbrur))

urban <- urbrur %>%
  select(Name = UR2019_V_1, Urban = IUR2019__1, AreaSQKM = AREA_SQ_KM, geometry)

unique(urban$Urban)
# neet to change columsn to say just urban or rural

urban$Urban[grep("urban", urban$Urban)] <- "Urban"
urban$Urban[grep("Rural", urban$Urban)] <- "Rural"
urban$Urban[grep("water", urban$Urban)] <- "Other"
urban$Urban[grep("Oceanic", urban$Urban)] <- "Other"
```

# 3. Pharmacy Location Data
Data source: https://fyi.org.nz/request/10183-total-number-of-licenced-pharmacies-in-nz-2019

Does this still count as tabular data even though I turned it into spatial data??
```{r pharm}

#?register_google

#nz.pharm <- read.csv("Pharmacy Database.csv")

#nz.pharm <- nz.pharm %>%
 # select(Pharmacy_Nm = PREMISES_NAME, Street = STREET_ADDRESS, Suburb = #STREET_ADDRESS_SUBURB_RD, City = STREET_ADDRESS_TOWN_CITY, zip = STREET_ADDRESS_POST_CODE)

#head(nz.pharm)

# create address column with full address (minus postal code)
#nz.pharm$address <- paste(nz.pharm$Street, nz.pharm$Suburb, nz.pharm$City, sep = ",")
# remove double "," for those that didn't have a suburb listed
#nz.pharm$address <- gsub(",,", ",", nz.pharm$address)

# initialize dataframe
#geocoded <- data.frame(stringsAsFactors = FALSE)

#for(i in 1:nrow(nz.pharm)) {
  # Print("Working...")
 # result <- geocode(nz.pharm$address[i], output = "latlona", source = "google")
 # nz.pharm$lon[i] <- as.numeric(result[1])
  #nz.pharm$lat[i] <- as.numeric(result[2])
#}

#write.csv(nz.pharm, here("nz.pharm.csv"))

# read in pharmacy csv created above that now has location data:

nz.pharm <- read.csv(here("nz.pharm.csv"))

nz.pharm <- na.omit(nz.pharm)
nz.pharm.sf <- st_as_sf(nz.pharm, coords = c("lon", "lat"), crs = 4326)
st_crs(nz.pharm.sf)
nz.pharm.proj <- st_transform(nz.pharm.sf, crs = st_crs(nz.reg.shp))
st_crs(nz.reg.shp) == st_crs(nz.pharm.proj)

plot(st_geometry(nz.reg.shp))
plot(st_geometry(nz.pharm.proj), add = TRUE)
#looks alright
```

# D. Creating Database

Spatial Join

Questions to Answer:
1. What is the percentage of urban and rural areas within each region?
2. What is the number of attacks in each urban type within each region?
3. What is the population density of each region (people/sqkm)?
4. What is the number of attacks per population in each region? (attacks/people)

```{r}

# make sure CRS are the same
st_crs(zombie.shp) == st_crs(urban)
zombie.shp.proj <- st_transform(zombie.shp, crs = st_crs(urban))
st_crs(zombie.shp.proj) == st_crs(urban)
st_crs(urban) == st_crs(nz.reg.shp)

# ended up using a nearest neighbor approach because I kept getting points 800 something rows when I started with 668 so something was getting duplicated:
zombie.urban.join <- st_join(urban, zombie.shp.proj, join = st_nn, k = 1, maxdist = 50)


zombie.urban.region.join <- st_join(zombie.urban.join, nz.reg.shp, join = st_within)


str(zombie.urban.region.join)

zombie.urban.region.ng <- st_drop_geometry(zombie.urban.region.join)

zombie.urban.region.df <- zombie.urban.region.ng %>%
  select(Urban, AreaSQKM.x, Attacks, Region)



zombie.urban.region.df <- as.data.frame(zombie.urban.region.df)

zombie.urban.region.df$Region <- as.factor(zombie.urban.region.df$Region)

zombie.urban.region.df$Attacks <- replace_na(zombie.urban.region.df$Attacks, 0)
zombie.urban.region.df$Attacks <- as.numeric(zombie.urban.region.df$Attacks)


summary.df <- zombie.urban.region.df %>% 
  group_by(Region, Urban) %>% 
  summarise(., sum(Attacks), sqkm_dis_total = sum(AreaSQKM.x))

summary.df <- rename(summary.df, Attacks = "sum(Attacks)")

summary.df$urban_attacks <- paste(summary.df$Urban, summary.df$Attacks, sep = ";")

summary.df.wide <- spread(summary.df, Urban, sqkm_dis_total, "0")
summary.df.wide <- spread(summary.df.wide, urban_attacks, Attacks)

str(summary.df.wide)

summary.df.wide$Other <- as.numeric(summary.df.wide$Other)
summary.df.wide$Rural <- as.numeric(summary.df.wide$Rural)
summary.df.wide$Urban <- as.numeric(summary.df.wide$Urban)

summary.df.wide <- summary.df.wide[!is.na(summary.df.wide$Region),]

summary.df.wide[is.na(summary.df.wide)] <- 0

summary.df.wide <- summary.df.wide %>%
  group_by(Region) %>%
  summarise_if(., is.numeric, sum)


summary.df.wide <- rename(summary.df.wide, Other_sqkm = "Other")
summary.df.wide <- rename(summary.df.wide, Rural_sqkm = "Rural")
summary.df.wide <- rename(summary.df.wide, Urban_sqkm = "Urban")


colnames(summary.df.wide)[grepl('Other;',colnames(summary.df.wide))] <- 'Other_attacks'
colnames(summary.df.wide)[grepl('Rural;',colnames(summary.df.wide))] <- 'Rural_attacks'
colnames(summary.df.wide)[grepl('Urban;',colnames(summary.df.wide))] <- 'Urban_attacks'

names(summary.df.wide) <- make.unique(names(summary.df.wide))
tidy.summary.df <- summary.df.wide %>%
  rowwise() %>%
  mutate(Rural_Attack_sum = sum(across(starts_with("Rural_attacks")), na.rm = T))

tidy.summary.df <- tidy.summary.df %>%
  rowwise() %>%
  mutate(Other_Attack_sum = sum(across(starts_with("Other_attacks")), na.rm = T))

tidy.summary.df <- tidy.summary.df %>%
  rowwise() %>%
  mutate(Urban_Attack_sum = sum(across(starts_with("Urban_attacks")), na.rm = T))


tidy.summary.df <- tidy.summary.df %>%
  select(Region, Other_sqkm, Rural_sqkm, Urban_sqkm, Other_Attack_sum, Rural_Attack_sum, Urban_Attack_sum)
### NEED TO FIX REGIONAL SQKM
```

```{r pharmperregion}

# Find the number of pharmacies per region

pharm.per.region <- st_join(nz.reg.shp, nz.pharm.proj, join = st_contains)
pharm.per.region.ng <- st_drop_geometry(pharm.per.region)
pharm.per.region.ng <- pharm.per.region.ng %>%
  select(Region, Pharmacy_Nm)

# Count the number of pharmacies in each region
pharm.per.region.count <- pharm.per.region.ng %>% 
  group_by(Region) %>%
  tally()
```

























